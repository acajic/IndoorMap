<html>


<head>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <link href='http://indoor.io/indoor.js/1.1.0/js/mapbox/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="mapbox.css" />

    <link rel="stylesheet" href="IndoorMap.css" />

</head>

<body>
    <div id="map" style="width: 100%; height: 100%;">
    </div>
</body>


<script src='http://indoor.io/indoor.js/1.1.0/js/jquery-1.9.1.min.js'> </script>
<script src='http://code.jquery.com/ui/jquery-ui-git.js'> </script>




<script src='scripts/indoor1.1.0.mapbox.js'></script>
<script src='scripts/indoor1.1.0.js'></script>


<script src='scripts/polygon.js'></script>    
<script src='scripts/indoorPolygon.js'></script>

<script src='scripts/roomFeatures.js'></script>
<script src='scripts/indoorFeatures.js'></script>

    <script type="text/javascript">
        
        // ************ PRIVATE *************

        var map;

        function go() {
            map = L.indoor.map('map', {
                    map: "06583882495760918064", // "scripts/Virtual-Up.json", //
                    project: "3a1a2e3979948c2732088a119debc5b4",// "5ac70dabddf7245e082d61240b819d5d",
                    click: indoorMapClicked
                },
                null,
                function () {
                    var levels = map.getLevels();
                    map.setLevel('1');
                });
        }

        go();


        function indoorMapClicked(event) {
        }



        var beacons = [];
        /*
            A standard beacon is a simple javascript object.

            
            var beacon = {
                id: id,
                level: level,
                lat: lat,
                lng: lng,
                wgsLat: wgsLat,
                wgsLng: wgsLng,
                uuid: uuid,
                major: major,
                minor: minor,
                name: name
            };

            'id' - No two beacons that are ever presented on the same map can ever have the same 'id'.
            
            Indoor.js uses local latitude and longitude values for manipulating the map markers, hightlights, routes, ... Local latitude and longitude values have 0 values at bottom left corner of the map.
            For permanent storage of beacons it is safer to store the global latitude and longitude values. These values are kept in 'wgsLat' and 'wgsLng' properties of a beacon (lat and lng properties are reserved for local coordinates).
            In order to populate local lat&lng properties based on wgsLat&wgsLng values, one can always call 'beacon = localizeBeacon(beacon)'; 

            
        */

        var localizingBeacon = null;
        function localizeBeacon(beacon) {
            beacon.lat = beacon.wgsLat;
            beacon.lng = beacon.wgsLng;
            localizingBeacon = beacon;
            map.convertLatLng(beacon, function (error, latLng) {
                localizingBeacon.lat = latLng.lat;
                localizingBeacon.lng = latLng.lng;
            });

            return localizingBeacon;
        }


        // ************ PUBLIC *************


        function setBeacons(beaconsArray) {
            beacons = [];
            for (var i = 0; i < beaconsArray.length; i++) {
                var beacon = beaconsArray[i];
                beacon = localizeBeacon(beacon);
            }
        }

        
        var highlightTags = {};
        var highlightedBeacon = null;
        function highlightBeacon(uuid, major, minor, tags) {
            highlightedBeacon = $.grep(beacons, function (someBeacon) {
                return someBeacon.uuid == uuid && someBeacon.major == major && someBeacon.minor == minor;
            })[0];

            if (!highlightedBeacon)
                return;


            getRoomFeaturesAtLatLng(highlightedBeacon, function (roomFeatures) {
                var roomFeature = roomFeatures[0];

                if (!roomFeature)
                    return;


                var sameRoomBeacons = [];
                for (var i = 0; i < beacons.length; i++) {
                    var beacon = beacons[i];
                    if (beacon.lat >= roomFeature.containerBox.minLat && beacon.lat <= roomFeature.containerBox.maxLat && beacon.lng >= roomFeature.containerBox.minLng && beacon.lng <= roomFeature.containerBox.maxLng) {
                        sameRoomBeacons.push(beacon);
                    }
                }
                
                var highlight = null;
                if (sameRoomBeacons.length == 0) {
                    // should not happen if roomFeature is not null
                } else if (sameRoomBeacons.length == 1) {
                    highlight = map.highlightFeatures(roomFeature.feature, { clickable: false, stroke: true, color: '#00ff00', opacity: '0.3' });
                } else {
                    
                    var squareFeature = squareFeatureAroundLatLng(highlightedBeacon, 0.0001);
                    var squarePolygon = featureToPolygon(squareFeature);
                    var roomPolygon = featureToPolygon(roomFeature.feature);
                    
                    var intersectingPolygon = intersectionPolygons(squarePolygon, roomPolygon);
                    var intersectingFeature = polygonToFeature(intersectingPolygon);

                    highlight = map.highlightFeatures(intersectingFeature, { clickable: false, stroke: true, color: '#0000ff', opacity: '0.3' });

                    

                }

                if (highlight) {
                    for (var i = 0; i < tags.length; i++) {
                        var tag = tags[i];
                        if (!highlightTags[tag])
                            highlightTags[tag] = [];

                        highlightTags[tag].push(highlight);
                    }
                }
                
            });
        }
        
        function removeHighlightsByTag(tag) {
            var highlights = highlightTags[tag];
            for (var i = 0; i < highlights.length; i++) {
                var highlight = highlights[i];
                map.clearHighlight(highlight);
            }
        }

    </script>

</html>
